<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±šå°å±‹æ¢æ¤œéšŠ - è±šå°å±‹ã«å…¥ã‚‰ãšã‚“ã°å­è±šã‚’å¾—ãš</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #04384c 0%, #022838 50%, #011825 100%);
            color: #e8f4f8; 
            min-height: 100vh; 
            padding: 10px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 0, 0, 0.7); border-radius: 15px; }
        .header h1 { color: #FFD700; font-size: 2em; margin-bottom: 8px; }
        .subtitle { color: #DC143C; font-style: italic; }
        .connection-status, .player-name-display { position: fixed; top: 10px; padding: 8px 15px; border-radius: 15px; font-weight: bold; z-index: 100; font-size: 12px; }
        .connection-status { right: 10px; background: rgba(220, 20, 60, 0.9); color: white; }
        .connection-status.connected { background: rgba(34, 139, 34, 0.9); }
        .player-name-display { left: 10px; background: rgba(255, 215, 0, 0.2); border: 2px solid #FFD700; display: none; }
        .error-message { background: rgba(220, 20, 60, 0.9); color: white; padding: 12px; border-radius: 8px; margin: 10px 0; text-align: center; display: none; }
        .btn { background: linear-gradient(45deg, #04384c, #065a7a); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; margin: 5px; width: 100%; }
        .btn:hover { background: linear-gradient(45deg, #065a7a, #0876a0); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #87CEEB; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #04384c; border-radius: 5px; background: rgba(0, 0, 0, 0.7); color: #e8f4f8; font-size: 16px; }
        .control-section { background: rgba(0, 0, 0, 0.5); padding: 15px; border-radius: 10px; border: 2px solid rgba(135, 206, 235, 0.2); margin-bottom: 15px; }
        .control-section h3 { color: #87CEEB; margin-bottom: 15px; }
        #lobby, #room-info, #game-board, #victory-screen { display: none; }
        #lobby { display: block; }
        .room-id-display { background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-size: 1.5em; font-weight: bold; border: 2px solid rgba(255, 215, 0, 0.5); }
        .players-list { background: rgba(4, 56, 76, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .player-item { padding: 10px; margin: 6px 0; background: rgba(0, 0, 0, 0.5); border-radius: 5px; }
        .game-info { background: rgba(4, 56, 76, 0.5); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .my-cards-section { background: rgba(4, 56, 76, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .my-cards-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .card { aspect-ratio: 3/4; border: 2px solid #04384c; border-radius: 8px; background: linear-gradient(135deg, #022838, #04384c); display: flex; align-items: center; justify-content: center; font-weight: bold; min-height: 60px; }
        .other-players-container { margin-bottom: 15px; }
        .other-player-box { background: rgba(0, 0, 0, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 2px solid rgba(135, 206, 235, 0.2); }
        .other-player-cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .other-card { aspect-ratio: 3/4; border: 2px solid #04384c; border-radius: 6px; background: linear-gradient(135deg, #011825, #04384c); cursor: pointer; min-height: 45px; }
        .victory-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .victory-content { background: linear-gradient(135deg, #04384c, #022838); padding: 30px; border-radius: 20px; text-align: center; border: 3px solid #FFD700; max-width: 400px; width: 100%; }
        .checkbox-group { margin-bottom: 15px; }
        .checkbox-group input { width: auto; margin-right: 10px; }
        .status-success { background: rgba(34, 139, 34, 0.9) !important; }
        .status-warning { background: rgba(255, 165, 0, 0.9) !important; }

        /* === è¿½åŠ æ”¹å–„æ©Ÿèƒ½ã®CSS === */
        .toast {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }
        
        .toast.show { transform: translateX(0); }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: #000; }
        .toast.info { background: #17a2b8; }
        
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #04384c, #022838);
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 2px solid #FFD700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-content h3 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
            border: 1px solid #FFD700;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .quick-join {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
            z-index: 100;
            display: none;
            transition: all 0.3s ease;
        }
        
        .quick-join:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.6);
        }

        .game-room-id {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 215, 0, 0.9);
            color: #04384c;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 101;
            display: none;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .toast {
                right: 10px;
                max-width: calc(100vw - 20px);
                top: 50px;
            }
            
            .quick-join {
                bottom: 80px;
                right: 15px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .game-room-id {
                position: relative;
                top: auto;
                left: auto;
                transform: none;
                display: block;
                text-align: center;
                margin-bottom: 10px;
            }
        }

        /* æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-success:hover {
            background: linear-gradient(45deg, #218838, #1ea085);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn-danger:hover {
            background: linear-gradient(45deg, #c82333, #a71e2a);
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connection-status">ğŸ”´ æœªæ¥ç¶š</div>
    <div class="player-name-display" id="player-name-display">ğŸ‘¤ <span id="my-name"></span></div>
    <div class="game-room-id" id="game-room-id">ğŸ  ãƒ«ãƒ¼ãƒ : <span id="game-room-id-text"></span></div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <h3 id="confirm-title">ç¢ºèª</h3>
            <p id="confirm-message">ã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</p>
            <div style="margin-top: 20px;">
                <button id="confirm-yes" class="btn btn-success" style="width: auto; margin: 5px;">ã¯ã„</button>
                <button id="confirm-no" class="btn btn-danger" style="width: auto; margin: 5px;">ã„ã„ãˆ</button>
            </div>
        </div>
    </div>
    
    <!-- ã‚¯ã‚¤ãƒƒã‚¯å‚åŠ ãƒœã‚¿ãƒ³ -->
    <button class="quick-join" id="quick-join" title="ãƒ©ãƒ³ãƒ€ãƒ ãƒ«ãƒ¼ãƒ ã«å‚åŠ ">ğŸ²</button>
    
    <!-- é€²æ—ãƒãƒ¼ -->
    <div class="progress-bar" id="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ· è±šå°å±‹æ¢æ¤œéšŠ ğŸ·</h1>
            <p class="subtitle">è±šå°å±‹ã«å…¥ã‚‰ãšã‚“ã°å­è±šã‚’å¾—ãš</p>
        </div>

        <div id="error-message" class="error-message"></div>

        <!-- ãƒ­ãƒ“ãƒ¼ç”»é¢ -->
        <div id="lobby" class="lobby">
            <div class="control-section">
                <h3>æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</h3>
                <div class="input-group">
                    <label for="player-name-create">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</label>
                    <input type="text" id="player-name-create" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="use-password">
                    <label for="use-password" style="display: inline;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹</label>
                </div>
                <div class="input-group" id="password-group" style="display: none;">
                    <label for="room-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                    <input type="password" id="room-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                </div>
                <button id="create-room" class="btn">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ (Ctrl+Enter)</button>
            </div>
            
            <div class="control-section">
                <h3>ãƒ«ãƒ¼ãƒ ã«å‚åŠ </h3>
                <div class="input-group">
                    <label for="player-name-join">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</label>
                    <input type="text" id="player-name-join" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label for="room-id-input">ãƒ«ãƒ¼ãƒ ID:</label>
                    <input type="text" id="room-id-input" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
                </div>
                <div class="input-group" id="join-password-group" style="display: none;">
                    <label for="join-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                    <input type="password" id="join-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                </div>
                <button id="join-room" class="btn">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
            </div>

            <div class="control-section">
                <h3>ã‚²ãƒ¼ãƒ ä¸­ã®ãƒ«ãƒ¼ãƒ ã«å†å…¥å ´</h3>
                <div class="input-group">
                    <label for="rejoin-player-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</label>
                    <input type="text" id="rejoin-player-name" placeholder="å…ƒã®åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label for="rejoin-room-id">ãƒ«ãƒ¼ãƒ ID:</label>
                    <input type="text" id="rejoin-room-id" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
                </div>
                <button id="rejoin-room" class="btn">ã‚²ãƒ¼ãƒ ã«å†å…¥å ´</button>
            </div>

            <div class="control-section">
                <h3>è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰</h3>
                <div class="input-group">
                    <label for="spectator-name">è¦³æˆ¦è€…å:</label>
                    <input type="text" id="spectator-name" placeholder="åå‰ã‚’å…¥åŠ›">
                </div>
                <div class="input-group">
                    <label for="spectate-room-id">ãƒ«ãƒ¼ãƒ ID:</label>
                    <input type="text" id="spectate-room-id" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
                </div>
                <button id="spectate-room" class="btn">è¦³æˆ¦ã™ã‚‹</button>
            </div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒ æƒ…å ±ç”»é¢ -->
        <div id="room-info" class="room-info">
            <div class="room-id-display">ãƒ«ãƒ¼ãƒ ID: <span id="room-id-display"></span></div>
            
            <div class="players-list">
                <h3>å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (<span id="player-count">0</span>/10)</h3>
                <div id="players-list"></div>
            </div>
            
            <div>
                <button id="start-game" class="btn btn-success" style="display: none;">ã‚²ãƒ¼ãƒ é–‹å§‹ (3äººä»¥ä¸Šå¿…è¦)</button>
                <button id="leave-room" class="btn btn-danger">ãƒ«ãƒ¼ãƒ ã‚’é€€å‡º</button>
                <button id="temp-leave-room" class="btn" style="display: none;">ä¸€æ™‚é€€å‡º</button>
                <button id="cancel-temp-leave" class="btn" style="display: none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>

            <div class="temp-leave-section" id="temp-leave-section" style="display: none;">
                <h4>âš ï¸ ã‚²ãƒ¼ãƒ ä¸­ã®ä¸€æ™‚é€€å‡º</h4>
                <p>ã‚²ãƒ¼ãƒ ä¸­ã§ã™ãŒã€ä¸€æ™‚çš„ã«é€€å‡ºã§ãã¾ã™ã€‚</p>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-board" class="game-board">
            <div class="game-info">
                <h3>ã‚²ãƒ¼ãƒ æƒ…å ±</h3>
                <p>ãƒ©ã‚¦ãƒ³ãƒ‰: <span id="current-round">1</span>/4</p>
                <p>è²¡å®: <span id="treasure-found">0</span>/<span id="treasure-goal">7</span></p>
                <p>ç½ : <span id="trap-triggered">0</span>/<span id="trap-goal">2</span></p>
                <p>éµä¿æŒè€…: <span id="key-holder-name">ä¸æ˜</span></p>
                <p id="turn-message">å¾…æ©Ÿä¸­...</p>
            </div>

            <div class="my-cards-section">
                <h3>ã‚ãªãŸã®ã‚«ãƒ¼ãƒ‰</h3>
                <p>å­è±š <span id="my-treasure">0</span> / ç½  <span id="my-trap">0</span> / ç©ºã <span id="my-empty">0</span></p>
                <div id="my-cards-grid" class="my-cards-grid"></div>
            </div>

            <div>
                <h3>ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h3>
                <div id="other-players-container" class="other-players-container"></div>
            </div>

            <button id="game-leave-room" class="btn btn-danger">ä¸€æ™‚é€€å‡º</button>
        </div>

        <!-- å‹åˆ©ç”»é¢ -->
        <div id="victory-screen" class="victory-screen">
            <div class="victory-content">
                <h2 id="victory-title"></h2>
                <p id="victory-message"></p>
                <div id="winners-list"></div>
                <button id="return-to-lobby-victory" class="btn btn-success">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- å¿…è¦ãªéš ã—è¦ç´  -->
    <div id="treasure-icons" style="display: none;"></div>
    <div id="trap-icons" style="display: none;"></div>
    <div id="role-reveal" style="display: none;">
        <div id="player-role"></div>
        <p id="role-description"></p>
        <img id="role-image" src="" alt="">
    </div>

    <!-- Socket.io CDN -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    
    <script>
        console.log('Enhancedçµ±åˆJavaScripté–‹å§‹');

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        const safeGetElement = (id) => document.getElementById(id);
        const safeSetText = (id, text) => {
            const el = safeGetElement(id);
            if (el) el.textContent = text;
        };
        const safeSetHTML = (id, html) => {
            const el = safeGetElement(id);
            if (el) el.innerHTML = html;
        };
        const safeAddEventListener = (id, event, handler) => {
            const element = safeGetElement(id);
            if (element) {
                element.addEventListener(event, handler);
                console.log(`âœ… ${id} ã«ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ æˆåŠŸ`);
            } else {
                console.warn(`âš ï¸ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: #${id}`);
            }
        };

        // Enhanced UIManager ã‚¯ãƒ©ã‚¹
        class UIManager {
            // æ–°æ©Ÿèƒ½ï¼šãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
            static showToast(message, type = 'info', duration = 3000) {
                // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‰Šé™¤
                document.querySelectorAll('.toast').forEach(toast => toast.remove());
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                setTimeout(() => toast.classList.add('show'), 100);
                
                // è‡ªå‹•å‰Šé™¤
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
            
            // æ–°æ©Ÿèƒ½ï¼šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            static showLoading(show = true) {
                const overlay = safeGetElement('loading-overlay');
                if (overlay) {
                    overlay.style.display = show ? 'flex' : 'none';
                }
            }
            
            // æ–°æ©Ÿèƒ½ï¼šç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            static showConfirm(title, message) {
                return new Promise((resolve) => {
                    const modal = safeGetElement('confirm-modal');
                    const titleEl = safeGetElement('confirm-title');
                    const messageEl = safeGetElement('confirm-message');
                    const yesBtn = safeGetElement('confirm-yes');
                    const noBtn = safeGetElement('confirm-no');
                    
                    if (!modal) {
                        resolve(false);
                        return;
                    }
                    
                    if (titleEl) titleEl.textContent = title;
                    if (messageEl) messageEl.textContent = message;
                    
                    modal.style.display = 'flex';
                    
                    const cleanup = () => {
                        modal.style.display = 'none';
                        yesBtn?.removeEventListener('click', handleYes);
                        noBtn?.removeEventListener('click', handleNo);
                    };
                    
                    const handleYes = () => {
                        cleanup();
                        resolve(true);
                    };
                    
                    const handleNo = () => {
                        cleanup();
                        resolve(false);
                    };
                    
                    yesBtn?.addEventListener('click', handleYes);
                    noBtn?.addEventListener('click', handleNo);

                    // Escapeã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    const handleEscape = (e) => {
                        if (e.key === 'Escape') {
                            cleanup();
                            resolve(false);
                            document.removeEventListener('keydown', handleEscape);
                        }
                    };
                    document.addEventListener('keydown', handleEscape);
                });
            }
            
            // æ–°æ©Ÿèƒ½ï¼šé€²æ—ãƒãƒ¼
            static showProgress(percent) {
                const progressBar = safeGetElement('progress-bar');
                const progressFill = safeGetElement('progress-fill');
                
                if (progressBar && progressFill) {
                    progressBar.style.display = 'block';
                    progressFill.style.width = `${Math.max(0, Math.min(100, percent))}%`;
                    
                    if (percent >= 100) {
                        setTimeout(() => {
                            progressBar.style.display = 'none';
                        }, 1500);
                    }
                }
            }

            // æ”¹å–„ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            static showError(message, type = 'error') {
                const errorEl = safeGetElement('error-message');
                if (!errorEl) return;
                
                errorEl.textContent = message;
                errorEl.className = 'error-message';
                
                if (type === 'success') {
                    errorEl.classList.add('status-success');
                } else if (type === 'warning') {
                    errorEl.classList.add('status-warning');
                }
                
                errorEl.style.display = 'block';
                
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, type === 'success' ? 3000 : 5000);

                // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚‚è¡¨ç¤º
                this.showToast(message, type);
            }

            static showConnectionStatus(status) {
                const statusEl = safeGetElement('connection-status');
                if (!statusEl) return;
                
                if (status === 'connected') {
                    statusEl.textContent = 'ğŸŸ¢ æ¥ç¶šæ¸ˆã¿';
                    statusEl.className = 'connection-status connected';
                } else {
                    statusEl.textContent = 'ğŸ”´ åˆ‡æ–­';
                    statusEl.className = 'connection-status disconnected';
                }
            }

            static showPlayerName(name) {
                const displayEl = safeGetElement('player-name-display');
                const nameEl = safeGetElement('my-name');
                
                if (displayEl && nameEl) {
                    displayEl.style.display = 'block';
                    nameEl.textContent = name;
                }
            }

            static showGameRoomId(roomId) {
                const gameRoomIdEl = safeGetElement('game-room-id');
                const gameRoomIdTextEl = safeGetElement('game-room-id-text');
                
                if (gameRoomIdEl && gameRoomIdTextEl) {
                    if (roomId) {
                        gameRoomIdTextEl.textContent = roomId;
                        gameRoomIdEl.style.display = 'block';
                    } else {
                        gameRoomIdEl.style.display = 'none';
                    }
                }
            }

            static showScreen(screenName) {
                const screens = ['lobby', 'room-info', 'game-board', 'victory-screen'];
                
                screens.forEach(screen => {
                    const element = safeGetElement(screen);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
                
                if (screenName) {
                    const screen = safeGetElement(screenName);
                    if (screen) {
                        screen.style.display = 'block';
                    }
                }

                // ã‚²ãƒ¼ãƒ ç”»é¢ã®å ´åˆã¯ãƒ«ãƒ¼ãƒ IDã‚’è¡¨ç¤º
                if (screenName === 'game-board' && window.game?.roomId) {
                    this.showGameRoomId(window.game.roomId);
                } else {
                    this.showGameRoomId(null);
                }
            }

            static updatePlayersList(players, hostId) {
                const container = safeGetElement('players-list');
                const countEl = safeGetElement('player-count');
                
                if (!container || !countEl) return;
                
                const count = players.filter(p => p.connected).length;
                countEl.textContent = count;
                
                container.innerHTML = '';
                players.forEach((player) => {
                    const div = document.createElement('div');
                    div.className = 'player-item';
                    if (player.id === hostId) {
                        div.classList.add('host');
                    }
                    
                    const status = player.connected ? 'ğŸŸ¢' : 'ğŸ”´';
                    const disconnectedText = player.connected ? '' : ' (åˆ‡æ–­ä¸­)';
                    div.textContent = `${status} ${player.name}${disconnectedText}`;
                    
                    if (!player.connected) {
                        div.style.opacity = '0.6';
                        div.style.fontStyle = 'italic';
                    }
                    
                    container.appendChild(div);
                });
            }
        }

        // SocketClient ã‚¯ãƒ©ã‚¹
        class SocketClient {
            constructor(game) {
                this.game = game;
                this.socket = null;
                this.initializeSocket();
            }

            initializeSocket() {
                try {
                    this.socket = io({
                        transports: ['websocket', 'polling'],
                        timeout: 5000
                    });
                    
                    this.setup
